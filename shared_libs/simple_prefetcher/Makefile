CXX=g++
CC=gcc

LIBS=-lpthread -lrt -ldl
FLAGS=-fPIC -shared -std=gnu++11 -Wno-unused-result
INCLUDE=

KB=1024
MB=`echo "$(KB)*1024" | bc`

NR_RA_PAGES=40
NR_WORKERS=2
PORTION_PAGES=32
NR_ADJACENT_CHECK=1
MIN_FILE_SZ=$(MB)

SOURCES = frontend.cpp utils/thpool.c utils/bitarray.c

#DEBUG=-DDEBUG
VAR_FLAGS=-DNR_RA_PAGES=$(NR_RA_PAGES) -DNR_WORKERS=$(NR_WORKERS) -DPORTION_PAGES=$(PORTION_PAGES)
VAR_FLAGS+=-DNR_ADJACENT_CHECK=$(NR_ADJACENT_CHECK) -DMIN_FILE_SZ=$(MIN_FILE_SZ)

DISABLE_FADV_RANDOM=-DDISABLE_FADV_RANDOM ##Disables any FADV_RANDOM from App
OS_ONLY=-DDISABLE_APP_READAHEADS
THPOOL_FILE_RA=-DTHPOOL_PREFETCH -DPREFETCH_READAHEAD -DFULL_PREFETCH -DBLIND_PREFETCH
THPOOL_BLOCK_RA=-DTHPOOL_PREFETCH -DPREFETCH_READAHEAD -DBLIND_PREFETCH
THPOOL_BLOCK_RA_BUDGET=-DTHPOOL_PREFETCH -DPREFETCH_READAHEAD -DBLIND_PREFETCH -DMODIFIED_RA
PREDICTOR_THPOOL_FILE_RA=-DTHPOOL_PREFETCH -DPREFETCH_READAHEAD -DFULL_PREFETCH -DPREDICTOR
PREDICTOR_THPOOL_BLOCK_RA=-DTHPOOL_PREFETCH -DPREFETCH_READAHEAD -DPREDICTOR
PREDICTOR_THPOOL_BLOCK_RA_BUDGET=-DTHPOOL_PREFETCH -DPREFETCH_READAHEAD -DPREDICTOR -DMODIFIED_RA

all: Vanilla OSonly Cross_FileRA_NoPred_MaxMem_BG Cross_FileRA_Pred_MaxMem_BG Cross_BlockRA_Pred_MaxMem_BG Cross_BlockRA_Pred_Budget_BG Cross_BlockRA_NoPred_Budget_BG Cross_BlockRA_NoPred_MaxMem_BG

#test: $(SOURCES)
Cross_BlockRA_Pred_Budget_BG: $(SOURCES)
	$(CXX) $(INCLUDE) $(FLAGS) -o lib_CBPBB.so $^ $(LIBS) $(DEBUG) \
	    $(VAR_FLAGS) $(DISABLE_FADV_RANDOM) $(PREDICTOR_THPOOL_BLOCK_RA_BUDGET)

Cross_FileRA_Pred_MaxMem_BG: $(SOURCES)
	$(CXX) $(INCLUDE) $(FLAGS) -o lib_CFPMB.so $^ $(LIBS) $(DEBUG) \
	    $(VAR_FLAGS) $(DISABLE_FADV_RANDOM) $(PREDICTOR_THPOOL_FILE_RA)

Cross_BlockRA_Pred_MaxMem_BG: $(SOURCES)
	$(CXX) $(INCLUDE) $(FLAGS) -o lib_CBPMB.so $^ $(LIBS) $(DEBUG) \
	    $(VAR_FLAGS) $(DISABLE_FADV_RANDOM) $(PREDICTOR_THPOOL_BLOCK_RA)

Cross_BlockRA_NoPred_MaxMem_BG: $(SOURCES)
	$(CXX) $(INCLUDE) $(FLAGS) -o lib_CBNMB.so $^ $(LIBS) $(DEBUG) \
	    $(VAR_FLAGS) $(DISABLE_FADV_RANDOM) $(THPOOL_BLOCK_RA)

Cross_BlockRA_NoPred_Budget_BG: $(SOURCES)
	$(CXX) $(INCLUDE) $(FLAGS) -o lib_CBNBB.so $^ $(LIBS) $(DEBUG) \
	    $(VAR_FLAGS) $(DISABLE_FADV_RANDOM) $(THPOOL_BLOCK_RA_BUDGET)

Cross_FileRA_NoPred_MaxMem_BG: $(SOURCES)
	$(CXX) $(INCLUDE) $(FLAGS) -o lib_CFNMB.so $^ $(LIBS) $(DEBUG) \
	    $(VAR_FLAGS) $(DISABLE_FADV_RANDOM) $(THPOOL_FILE_RA)

OSonly: $(SOURCES)
	$(CXX) $(INCLUDE) $(FLAGS) -o lib_OSonly.so $^ $(LIBS) $(DEBUG) \
	    $(VAR_FLAGS) $(DISABLE_FADV_RANDOM) $(OS_ONLY)

Vanilla: $(SOURCES)
	$(CXX) $(INCLUDE) $(FLAGS) -o lib_Vanilla.so $^ $(LIBS) $(DEBUG) \
	    $(VAR_FLAGS)

install:
	sudo cp *.so /usr/local/lib
	sudo cp *.so /usr/lib
